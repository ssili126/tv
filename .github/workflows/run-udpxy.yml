name: Run UDPXY and Generate TXT

on:
  workflow_dispatch:  # 手动触发
  push:               # 代码推送时触发
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点运行

jobs:
  run-udpxy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: gzj7003/tv
        path: tv-repo
        
    - name: Setup directory
      run: |
        cd tv-repo/udpxy
        ls -la  # 查看目录内容
        pwd
        
    - name: Check if executable exists
      id: check_files
      run: |
        cd tv-repo/udpxy
        # 查找可执行文件
        find . -type f -executable -o -name "*.exe" -o -name "*.sh" | head -5
        # 检查Makefile或编译文件
        ls -la *.c *.cpp Makefile 2>/dev/null || true
        
    - name: Try to compile if needed
      run: |
        cd tv-repo/udpxy
        if [ -f "Makefile" ]; then
          echo "Found Makefile, attempting to compile..."
          make || true
        fi
        if [ -f "configure" ]; then
          echo "Found configure script..."
          chmod +x configure || true
          ./configure || true
          make || true
        fi
        
    - name: Run the program and generate TXT
      run: |
        cd tv-repo/udpxy
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        
        # 尝试查找并运行程序
        # 修改这里的程序名以匹配实际的可执行文件
        EXECUTABLE=""
        if [ -f "udpxy" ]; then
          EXECUTABLE="./udpxy"
        elif [ -f "udpxy.exe" ]; then
          EXECUTABLE="./udpxy.exe"
        elif [ -f "main" ]; then
          EXECUTABLE="./main"
        fi
        
        if [ ! -z "$EXECUTABLE" ]; then
          echo "Running executable: $EXECUTABLE"
          chmod +x $EXECUTABLE || true
          # 运行程序（这里可能需要参数，根据实际情况调整）
          timeout 10s $EXECUTABLE --help > output.txt 2>&1 || \
          timeout 10s $EXECUTABLE -h > output.txt 2>&1 || \
          timeout 10s $EXECUTABLE > output.txt 2>&1 || true
        else
          echo "No executable found, creating test output..."
          echo "Program run at: $(date)" > output.txt
          echo "UDPXY test output" >> output.txt
          echo "Generated by GitHub Actions" >> output.txt
        fi
        
        echo "Generated output.txt content:"
        cat output.txt || true
        
    - name: Commit generated file
      run: |
        cd tv-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "udpxy/output.txt" ]; then
          git add udpxy/output.txt
          git commit -m "Add generated output.txt from GitHub Actions" || echo "No changes to commit"
        fi
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        directory: tv-repo
        branch: main
